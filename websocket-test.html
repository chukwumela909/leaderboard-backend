<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard WebSocket Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .notification { padding: 10px; margin: 5px 0; border-left: 4px solid #007bff; background: #f8f9fa; }
        .high-score { border-left-color: #28a745; background: #d4edda; }
        .new-player { border-left-color: #17a2b8; background: #d1ecf1; }
        .leaderboard-update { border-left-color: #ffc107; background: #fff3cd; }
        .controls { margin: 10px 0; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
        input { padding: 8px; margin: 5px; }
        .status { font-weight: bold; }
        .connected { color: green; }
        .disconnected { color: red; }
        ul { list-style: none; padding: 0; }
        li { padding: 5px; margin: 2px 0; background: #f8f9fa; border-radius: 3px; }
    </style>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="container">
        <h1>üèÜ Leaderboard WebSocket Test</h1>
        
        <div class="section">
            <h2>Connection Status</h2>
            <div id="status" class="status disconnected">Disconnected</div>
            <div class="controls">
                <button onclick="connect()">Connect</button>
                <button onclick="disconnect()">Disconnect</button>
                <button onclick="ping()">Ping Server</button>
            </div>
        </div>

        <div class="section">
            <h2>üéØ Test Notifications</h2>
            <div class="controls">
                <input type="text" id="testMessage" placeholder="Enter test message" />
                <button onclick="sendTestNotification()">Send Test Notification</button>
                <button onclick="requestLeaderboard()">Request Leaderboard</button>
                <button onclick="clearNotifications()">Clear Notifications</button>
            </div>
        </div>

        <div class="section">
            <h2>üìä Current Leaderboard</h2>
            <div id="leaderboard">
                <p>No leaderboard data yet. Click "Request Leaderboard" to fetch.</p>
            </div>
        </div>

        <div class="section">
            <h2>üì¢ Live Notifications</h2>
            <div id="notifications">
                <p>No notifications yet. Connect and submit some scores!</p>
            </div>
        </div>

        <div class="section">
            <h2>üîß Connection Info</h2>
            <div id="connectionInfo">
                <p>Socket ID: <span id="socketId">Not connected</span></p>
                <p>Connected at: <span id="connectedAt">-</span></p>
            </div>
        </div>
    </div>

    <script>
        let socket = null;
        
        function connect() {
            if (socket && socket.connected) {
                console.log('Already connected');
                return;
            }
            
            socket = io('http://localhost:3002');
            
            socket.on('connect', () => {
                console.log('Connected to server');
                document.getElementById('status').textContent = 'Connected';
                document.getElementById('status').className = 'status connected';
                document.getElementById('socketId').textContent = socket.id;
                document.getElementById('connectedAt').textContent = new Date().toLocaleString();
            });
            
            socket.on('disconnect', () => {
                console.log('Disconnected from server');
                document.getElementById('status').textContent = 'Disconnected';
                document.getElementById('status').className = 'status disconnected';
                document.getElementById('socketId').textContent = 'Not connected';
            });
            
            socket.on('welcome', (data) => {
                addNotification('Welcome: ' + data.message, 'notification');
            });
            
            socket.on('notification', (data) => {
                addNotification(`${data.type}: ${data.message}`, 'notification');
            });
            
            socket.on('high_score', (data) => {
                addNotification(`üéâ HIGH SCORE: ${data.message}`, 'high-score');
            });
            
            socket.on('new_player', (data) => {
                addNotification(`üëã NEW PLAYER: ${data.message}`, 'new-player');
            });
            
            socket.on('leaderboard_update', (data) => {
                addNotification('üìä Leaderboard updated!', 'leaderboard-update');
                updateLeaderboard(data.topScores);
            });
            
            socket.on('pong', (data) => {
                addNotification('üèì Pong received at ' + data.timestamp, 'notification');
            });
        }
        
        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
        }
        
        function ping() {
            if (socket && socket.connected) {
                socket.emit('ping');
            } else {
                alert('Not connected to server');
            }
        }
        
        function sendTestNotification() {
            const message = document.getElementById('testMessage').value;
            if (!message) {
                alert('Please enter a test message');
                return;
            }
            
            fetch('http://localhost:3002/api/leaderboard/ws/test-notification', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message, type: 'TEST' }),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Test notification sent:', data);
                document.getElementById('testMessage').value = '';
            })
            .catch(error => {
                console.error('Error sending test notification:', error);
                alert('Error sending test notification');
            });
        }
        
        function requestLeaderboard() {
            if (socket && socket.connected) {
                socket.emit('request_leaderboard');
            } else {
                alert('Not connected to server');
            }
        }
        
        function updateLeaderboard(scores) {
            const leaderboardDiv = document.getElementById('leaderboard');
            if (!scores || scores.length === 0) {
                leaderboardDiv.innerHTML = '<p>No scores available</p>';
                return;
            }
            
            const html = `
                <ul>
                    ${scores.map((score, index) => `
                        <li>
                            #${index + 1} - ${score.username}: ${score.score.toLocaleString()} points
                            <small style="color: #666; display: block;">
                                ${new Date(score.timestamp).toLocaleString()}
                            </small>
                        </li>
                    `).join('')}
                </ul>
            `;
            leaderboardDiv.innerHTML = html;
        }
        
        function addNotification(message, type) {
            const notificationsDiv = document.getElementById('notifications');
            if (notificationsDiv.children.length === 1 && notificationsDiv.children[0].tagName === 'P') {
                notificationsDiv.innerHTML = '';
            }
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <strong>${new Date().toLocaleTimeString()}</strong> - ${message}
            `;
            notificationsDiv.insertBefore(notification, notificationsDiv.firstChild);
            
            // Keep only last 20 notifications
            while (notificationsDiv.children.length > 20) {
                notificationsDiv.removeChild(notificationsDiv.lastChild);
            }
        }
        
        function clearNotifications() {
            document.getElementById('notifications').innerHTML = '<p>No notifications yet. Connect and submit some scores!</p>';
        }
        
        // Auto-connect on page load
        window.onload = function() {
            connect();
        };
    </script>
</body>
</html>
